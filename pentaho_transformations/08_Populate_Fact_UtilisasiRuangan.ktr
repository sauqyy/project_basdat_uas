<?xml version="1.0" encoding="UTF-8"?>
<transformation>
  <info>
    <name>08_Populate_Fact_UtilisasiRuangan</name>
    <description>Populate FactUtilisasiRuangan from fact_jadwal aggregated data</description>
    <extended_description>ETL Transformation to aggregate FactJadwal data and populate FactUtilisasiRuangan fact table for room utilization analysis.</extended_description>
    <trans_version>1.0</trans_version>
    <trans_type>Normal</trans_type>
  </info>
  <order>
    <hop>
      <from>Table Input - FactJadwal</from>
      <to>Group By - Aggregate by Room</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Group By - Aggregate by Room</from>
      <to>Calculator - Calculate Utilization</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Calculator - Calculate Utilization</from>
      <to>Table Output - FactUtilisasiRuangan</to>
      <enabled>Y</enabled>
    </hop>
  </order>
  <steps>
    <step>
      <name>Table Input - FactJadwal</name>
      <type>TableInput</type>
      <connection>DW_Connection</connection>
      <sql>SELECT 
    ruangan_key,
    waktu_key,
    prodi_key,
    durasi_menit,
    jumlah_mahasiswa,
    kapasitas_kelas
FROM fact_jadwal
WHERE status_aktif = 1;</sql>
    </step>
    <step>
      <name>Group By - Aggregate by Room</name>
      <type>GroupBy</type>
      <group>
        <name>ruangan_key</name>
        <subject>ruangan_key</subject>
        <type>Group</type>
      </group>
      <group>
        <name>waktu_key</name>
        <subject>waktu_key</subject>
        <type>Group</type>
      </group>
      <group>
        <name>prodi_key</name>
        <subject>prodi_key</subject>
        <type>Group</type>
      </group>
      <aggregate>
        <name>total_jam_penggunaan</name>
        <subject>durasi_menit</subject>
        <type>Sum</type>
      </aggregate>
      <aggregate>
        <name>total_mahasiswa</name>
        <subject>jumlah_mahasiswa</subject>
        <type>Sum</type>
      </aggregate>
      <aggregate>
        <name>max_kapasitas</name>
        <subject>kapasitas_kelas</subject>
        <type>Maximum</type>
      </aggregate>
    </step>
    <step>
      <name>Calculator - Calculate Utilization</name>
      <type>Calculator</type>
      <calculation>
        <field>
          <name>total_jam_tersedia</name>
          <type>Integer</type>
          <value>480</value>
        </field>
        <field>
          <name>persentase_utilisasi</name>
          <type>Number</type>
          <value>CASE 
    WHEN total_jam_tersedia > 0 THEN (total_jam_penggunaan / total_jam_tersedia) * 100
    ELSE 0
END</value>
        </field>
      </calculation>
    </step>
    <step>
      <name>Table Output - FactUtilisasiRuangan</name>
      <type>TableOutput</type>
      <connection>DW_Connection</connection>
      <table>fact_utilisasi_ruangan</table>
      <commit>1000</commit>
      <use_batch>Y</use_batch>
      <specify_fields>Y</specify_fields>
      <fields>
        <field><column>ruangan_key</column><name>ruangan_key</name></field>
        <field><column>waktu_key</column><name>waktu_key</name></field>
        <field><column>prodi_key</column><name>prodi_key</name></field>
        <field><column>total_jam_penggunaan</column><name>total_jam_penggunaan</name></field>
        <field><column>total_jam_tersedia</column><name>total_jam_tersedia</name></field>
        <field><column>persentase_utilisasi</column><name>persentase_utilisasi</name></field>
      </fields>
    </step>
  </steps>
</transformation>

